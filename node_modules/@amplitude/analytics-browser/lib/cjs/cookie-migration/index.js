var _this = this;
Object.defineProperty(exports, "__esModule", { value: true });
exports.decode = exports.parseTime = exports.parseLegacyCookies = void 0;
var tslib_1 = require("tslib");
var analytics_client_common_1 = require("@amplitude/analytics-client-common");
var config_1 = require("../config");
var parseLegacyCookies = function (apiKey, options) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
    var storage, oldCookieName, cookies, _a, deviceId, userId, optOut, sessionId, lastEventTime, lastEventId;
    var _b;
    return tslib_1.__generator(this, function (_c) {
        switch (_c.label) {
            case 0: return [4 /*yield*/, (0, config_1.createCookieStorage)(options)];
            case 1:
                storage = _c.sent();
                oldCookieName = (0, analytics_client_common_1.getOldCookieName)(apiKey);
                return [4 /*yield*/, storage.getRaw(oldCookieName)];
            case 2:
                cookies = _c.sent();
                if (!cookies) {
                    return [2 /*return*/, {
                            optOut: false,
                        }];
                }
                if (!((_b = options.cookieUpgrade) !== null && _b !== void 0 ? _b : (0, config_1.getDefaultConfig)().cookieUpgrade)) return [3 /*break*/, 4];
                return [4 /*yield*/, storage.remove(oldCookieName)];
            case 3:
                _c.sent();
                _c.label = 4;
            case 4:
                _a = tslib_1.__read(cookies.split('.'), 6), deviceId = _a[0], userId = _a[1], optOut = _a[2], sessionId = _a[3], lastEventTime = _a[4], lastEventId = _a[5];
                return [2 /*return*/, {
                        deviceId: deviceId,
                        userId: (0, exports.decode)(userId),
                        sessionId: (0, exports.parseTime)(sessionId),
                        lastEventId: (0, exports.parseTime)(lastEventId),
                        lastEventTime: (0, exports.parseTime)(lastEventTime),
                        optOut: Boolean(optOut),
                    }];
        }
    });
}); };
exports.parseLegacyCookies = parseLegacyCookies;
var parseTime = function (num) {
    var integer = parseInt(num, 32);
    if (isNaN(integer)) {
        return undefined;
    }
    return integer;
};
exports.parseTime = parseTime;
var decode = function (value) {
    if (!atob || !escape || !value) {
        return undefined;
    }
    try {
        return decodeURIComponent(escape(atob(value)));
    }
    catch (_a) {
        return undefined;
    }
};
exports.decode = decode;
//# sourceMappingURL=index.js.map